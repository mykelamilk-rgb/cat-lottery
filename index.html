<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿æ‹¼å›¾ - æœ¬åœ°ç»ˆæç‰ˆ</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --grid-gap: 8px;
            --piece-size: 100px;
            --highlight-color: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            padding-top: 30px;
        }

        /* æ ‡é¢˜ä¸æ¬¡æ•° */
        .header-info { text-align: center; margin-bottom: 20px; }
        .limit-badge {
            background: #f39c12;
            color: #333;
            padding: 5px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ä¹å®«æ ¼å®¹å™¨ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, var(--piece-size));
            grid-template-rows: repeat(3, var(--piece-size));
            gap: var(--grid-gap);
            background: #34495e;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .piece {
            width: var(--piece-size);
            height: var(--piece-size);
            background-color: #95a5a6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: rgba(255,255,255,0.2);
            border-radius: 8px;
            position: relative;
            background-repeat: no-repeat;
            overflow: hidden;
        }

        /* 1. æš¹ç½—çŒ«èƒŒæ™¯å›¾ (ä½¿ç”¨ä½ ä¸Šä¼ çš„åŸå§‹æ–‡ä»¶å)
           æ³¨æ„ï¼šç¡®ä¿å›¾ç‰‡å’Œhtmlåœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ 
        */
        .piece.collected {
            background-image: url('350174c9ccdc010785e3113662f8190a.jpg'); 
            background-size: 300px 300px; /* 3å€æ ¼å®½ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤º */
            color: transparent;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
        }

        /* 2. æ»šåŠ¨é«˜äº®ï¼šç¾çŸ­çŒ«å›¾ç‰‡ (ä½¿ç”¨ä½ ä¸Šä¼ çš„åŸå§‹æ–‡ä»¶å)
           å·²ç§»é™¤ç™½æ¡†ï¼Œå®Œå…¨é€æ˜èƒŒæ™¯ 
        */
        .piece.active {
            z-index: 10;
            background-image: url('79107df318fe1565ed0e682ec6117ef7.jpg') !important;
            background-size: cover !important;
            background-position: center !important;
            background-color: transparent !important; /* å½»åº•é€æ˜ */
            box-shadow: 0 0 15px var(--highlight-color);
            border: none !important;
            color: transparent;
        }

        .piece.miss::after {
            content: 'æœªä¸­';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
        }

        .controls { margin-top: 30px; display: flex; gap: 15px; }

        button {
            padding: 12px 35px;
            font-size: 18px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        #startBtn { background: var(--highlight-color); color: #333; }
        #startBtn:disabled { background: #7f8c8d; cursor: not-allowed; color: #ccc; }
        #resetBtn { background: #e74c3c; color: white; font-size: 14px; }

        .status-text { margin-top: 15px; height: 20px; color: #bdc3c7; font-size: 14px; }
    </style>
</head>
<body>

    <div class="header-info">
        <h1>ğŸ§© æ‹¼å›¾å¤§æŠ½å¥–</h1>
        <div class="limit-badge" id="limitInfo">è¯»å–ä¸­...</div>
    </div>

    <div class="grid-container" id="grid"></div>

    <div id="status" class="status-text">æ¯å¤©éƒ½èƒ½æŠ½ 3 æ¬¡ï¼Œä¸­ä¸ä¸­éƒ½æ‰£æ¬¡æ•°å“¦</div>

    <div class="controls">
        <button id="startBtn" onclick="startGame()">å¼€å§‹æŠ½å¥–</button>
        <button id="resetBtn" onclick="resetAll()">é‡ç½®è¿›åº¦</button>
    </div>

    <video id="drawAudio" src="ca0876475876a5ba3b5cbcf81e7c0a74.mp4" style="display:none;"></video>

    <script>
        const CONFIG = {
            maxDaily: 3,
            winRate: 0.5,
            path: [0, 1, 2, 5, 8, 7, 6, 3] 
        };

        let gameState = { collected: new Array(9).fill(false), isAnimating: false };
        let dailyState = { date: '', count: 0 };
        const audio = document.getElementById('drawAudio');

        function init() {
            const gridEl = document.getElementById('grid');
            gridEl.innerHTML = '';
            for(let i=0; i<9; i++) {
                const div = document.createElement('div');
                div.className = 'piece';
                div.id = `piece-${i}`;
                div.innerText = i + 1;
                // èƒŒæ™¯ç²¾å‡†å®šä½ï¼šå®ç°â€œå“ªé‡Œäº®äº†è§£é”å“ªé‡Œâ€
                div.style.backgroundPosition = `${(i % 3) * -100}px ${Math.floor(i / 3) * -100}px`;
                gridEl.appendChild(div);
            }
            loadData();
            refreshUI();
        }

        function loadData() {
            const progress = localStorage.getItem('local_puzzle_v1');
            if (progress) gameState.collected = JSON.parse(progress);
            
            const today = new Date().toLocaleDateString();
            const daily = localStorage.getItem('local_daily_v1');
            if (daily) {
                dailyState = JSON.parse(daily);
                if (dailyState.date !== today) dailyState = { date: today, count: 0 };
            } else {
                dailyState = { date: today, count: 0 };
            }
        }

        function refreshUI() {
            const left = CONFIG.maxDaily - dailyState.count;
            document.getElementById('limitInfo').innerText = `ä»Šæ—¥å‰©ä½™: ${left} / ${CONFIG.maxDaily}`;
            
            const btn = document.getElementById('startBtn');
            
            // åªè¦æ²¡é›†é½ï¼Œä¸”è¿˜æœ‰æ¬¡æ•°ï¼Œå°±ä¿æŒæŒ‰é’®å¯ç”¨
            if (gameState.collected.every(Boolean)) {
                btn.disabled = true;
                btn.innerText = "å·²é›†é½";
                document.getElementById('status').innerText = "ğŸ† æ­å–œï¼æš¹ç½—çŒ«å·²ç»æ‹¼å¥½å•¦ï¼";
            } else if (left <= 0) {
                btn.disabled = true;
                btn.innerText = "æ˜æ—¥å†æ¥";
                document.getElementById('status').innerText = "ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ";
            } else {
                btn.disabled = false;
                btn.innerText = "å¼€å§‹æŠ½å¥–";
            }

            gameState.collected.forEach((owned, i) => {
                const el = document.getElementById(`piece-${i}`);
                if (owned) {
                    el.classList.add('collected');
                    el.innerText = '';
                }
            });

            localStorage.setItem('local_puzzle_v1', JSON.stringify(gameState.collected));
            localStorage.setItem('local_daily_v1', JSON.stringify(dailyState));
        }

        function startGame() {
            if (gameState.isAnimating || dailyState.count >= CONFIG.maxDaily) return;

            // 1. ç«‹å³æ‰£é™¤æ¬¡æ•°å¹¶åˆ·æ–°ç•Œé¢
            dailyState.count++;
            // è¿™é‡Œä¸ç«‹å³è°ƒç”¨refreshUIä»¥é˜²æŒ‰é’®é—ªçƒï¼Œä»…ä¿å­˜æ•°æ®
            localStorage.setItem('local_daily_v1', JSON.stringify(dailyState));
            document.getElementById('limitInfo').innerText = `ä»Šæ—¥å‰©ä½™: ${CONFIG.maxDaily - dailyState.count} / ${CONFIG.maxDaily}`;

            gameState.isAnimating = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('status').innerText = "ç¾çŸ­çŒ«æ­£åœ¨è·³è·ƒ...";
            
            // æ’­æ”¾å£°éŸ³
            audio.currentTime = 0;
            audio.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾éœ€äº¤äº’"));

            // 2. å†³å®šç»“æœ
            const unowned = [];
            gameState.collected.forEach((v, i) => { if(!v) unowned.push(i); });
            const isWin = Math.random() < CONFIG.winRate && unowned.length > 0;
            const targetIdx = isWin ? unowned[Math.floor(Math.random()*unowned.length)] : Math.floor(Math.random()*9);
            
            // 3. åŠ¨ç”»æ§åˆ¶
            let step = 0;
            const finalPathIdx = targetIdx === 4 ? 8 : CONFIG.path.indexOf(targetIdx);
            const totalSteps = 24 + finalPathIdx; // è½¬3åœˆ

            function run() {
                document.querySelectorAll('.piece').forEach(p => p.classList.remove('active', 'miss'));
                let cur = (step === totalSteps && targetIdx === 4) ? 4 : CONFIG.path[step % 8];
                document.getElementById(`piece-${cur}`).classList.add('active');

                if (step >= totalSteps) {
                    gameState.isAnimating = false;
                    audio.pause();
                    
                    if (isWin) {
                        gameState.collected[targetIdx] = true;
                        document.getElementById('status').innerText = "âœ¨ ä¸­å¥–å•¦ï¼è§£é”äº†å¯¹åº”çš„æ‹¼å›¾å—ï¼";
                    } else {
                        document.getElementById(`piece-${targetIdx}`).classList.add('miss');
                        document.getElementById('status').innerText = "ğŸ’¨ æ²¡ä¸­ï¼Œæ˜å¤©å†æ¥ï¼";
                    }
                    
                    // å»¶è¿Ÿåˆ·æ–°UIï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœè¿˜æœ‰æ¬¡æ•°ï¼‰
                    setTimeout(() => {
                        document.querySelectorAll('.piece').forEach(p => p.classList.remove('miss'));
                        refreshUI(); 
                    }, 1200);
                    return;
                }
                step++;
                // å‡é€Ÿç®—æ³•
                let delay = step > totalSteps - 10 ? 80 + (step - (totalSteps - 10)) * 50 : 80;
                setTimeout(run, delay);
            }
            run();
        }

        function resetAll() {
            if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¿›åº¦ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>